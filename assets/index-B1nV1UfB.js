var R=Object.defineProperty;var x=(g,e,t)=>e in g?R(g,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):g[e]=t;var h=(g,e,t)=>x(g,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function t(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(n){if(n.ep)return;n.ep=!0;const i=t(n);fetch(n.href,i)}})();class I{constructor(e,t,s){h(this,"board");this.board={rows:e,cols:t,mines:s,cells:[],minesGenerated:!1},this.initializeBoard()}initializeBoard(){this.board.cells=[];for(let e=0;e<this.board.rows;e++){const t=[];for(let s=0;s<this.board.cols;s++)t.push({row:e,col:s,isMine:!1,adjacentMines:0,isRevealed:!1,isFlagged:!1});this.board.cells.push(t)}}getBoard(){return this.board}getCell(e,t){return this.isValidCell(e,t)?this.board.cells[e][t]:null}getNeighbors(e,t){const s=[],n=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];for(const[i,a]of n){const r=e+i,l=t+a;this.isValidCell(r,l)&&s.push(this.board.cells[r][l])}return s}getAdjacentMineCount(e,t){return this.getNeighbors(e,t).filter(n=>n.isMine).length}calculateAdjacentMines(){for(let e=0;e<this.board.rows;e++)for(let t=0;t<this.board.cols;t++){const s=this.board.cells[e][t];s.isMine||(s.adjacentMines=this.getAdjacentMineCount(e,t))}}setMine(e,t){return this.isValidCell(e,t)?(this.board.cells[e][t].isMine=!0,!0):!1}isValidCell(e,t){return e>=0&&e<this.board.rows&&t>=0&&t<this.board.cols}getForbiddenCells(e,t){const s=new Set;return this.getCell(e,t)&&(s.add(this.cellKey(e,t)),this.getNeighbors(e,t).forEach(i=>{s.add(this.cellKey(i.row,i.col))})),s}cellKey(e,t){return`${e},${t}`}clone(){const e=new I(this.board.rows,this.board.cols,this.board.mines);return e.board=JSON.parse(JSON.stringify(this.board)),e}setMinesGenerated(e){this.board.minesGenerated=e}areMinesGenerated(){return this.board.minesGenerated}getMineLocations(){const e=[];for(let t=0;t<this.board.rows;t++)for(let s=0;s<this.board.cols;s++)this.board.cells[t][s].isMine&&e.push({row:t,col:s});return e}getUnrevealedCount(){let e=0;for(let t=0;t<this.board.rows;t++)for(let s=0;s<this.board.cols;s++)this.board.cells[t][s].isRevealed||e++;return e}}class L{static generateMines(e,t,s){const n=e.getForbiddenCells(t,s),i=[],a=e.getBoard();for(let l=0;l<a.rows;l++)for(let c=0;c<a.cols;c++){const E=e.cellKey(l,c);n.has(E)||i.push({row:l,col:c})}const r=this.shuffleArray(i);for(let l=0;l<a.mines&&l<r.length;l++){const{row:c,col:E}=r[l];e.setMine(c,E)}e.calculateAdjacentMines(),e.setMinesGenerated(!0)}static shuffleArray(e){const t=[...e];for(let s=t.length-1;s>0;s--){const n=Math.floor(Math.random()*(s+1));[t[s],t[n]]=[t[n],t[s]]}return t}static getEmptyRegion(e,t,s){const n=e.getCell(t,s);if(!n||n.isMine||n.adjacentMines>0)return new Set([e.cellKey(t,s)]);const i=new Set,a=[{row:t,col:s}],r=new Set;for(;a.length>0;){const{row:l,col:c}=a.shift(),E=e.cellKey(l,c);if(r.has(E))continue;r.add(E);const y=e.getCell(l,c);if(!(!y||y.isMine)&&(i.add(E),y.adjacentMines===0)){const C=e.getNeighbors(l,c);for(const S of C){const v=e.cellKey(S.row,S.col);r.has(v)||a.push({row:S.row,col:S.col})}}}return i}}class U{constructor(e,t,s){h(this,"board");h(this,"gameState");h(this,"timerInterval",null);h(this,"listeners",new Map);this.board=new I(e,t,s),this.gameState={board:this.board.getBoard(),status:"playing",elapsedTime:0,minesRemaining:s,cellsRevealed:0,hasUsedUndo:!1}}revealCell(e,t){if(this.gameState.status!=="playing")return!1;const s=this.board.getCell(e,t);return!s||s.isRevealed||s.isFlagged?!1:(this.board.areMinesGenerated()||(L.generateMines(this.board,e,t),this.startTimer()),this.reveal(e,t))}reveal(e,t,s=!1){const n=this.board.getCell(e,t);if(!n||n.isRevealed||n.isFlagged)return!1;if(n.isRevealed=!0,this.gameState.cellsRevealed++,this.emit("cell-revealed",{row:e,col:t}),n.isMine)return this.endGame("lost"),this.revealAllMines(),!1;if(n.adjacentMines===0&&!s){const i=L.getEmptyRegion(this.board,e,t);for(const a of i){const[r,l]=a.split(",").map(Number);(r!==e||l!==t)&&this.reveal(r,l,!0)}}return this.checkWin()&&this.endGame("won"),!0}toggleFlag(e,t){if(this.gameState.status!=="playing")return!1;const s=this.board.getCell(e,t);return!s||s.isRevealed?!1:(s.isFlagged=!s.isFlagged,this.gameState.minesRemaining+=s.isFlagged?-1:1,this.emit("flag-toggled",{row:e,col:t,isFlagged:s.isFlagged}),!0)}chord(e,t){if(this.gameState.status!=="playing")return!1;const s=this.board.getCell(e,t);if(!s||!s.isRevealed||s.adjacentMines===0)return!1;const n=this.board.getNeighbors(e,t);if(n.filter(r=>r.isFlagged).length!==s.adjacentMines)return!1;let a=!1;for(const r of n)!r.isRevealed&&!r.isFlagged&&this.reveal(r.row,r.col,!1)&&(a=!0);return a}checkWin(){const e=this.board.getBoard(),t=e.rows*e.cols-e.mines;return this.gameState.cellsRevealed===t}endGame(e){this.stopTimer(),this.emit(`game-${e}`,{time:this.gameState.elapsedTime,hasUsedUndo:this.gameState.hasUsedUndo})}revealAllMines(){const e=this.board.getMineLocations();for(const{row:t,col:s}of e){const n=this.board.getCell(t,s);n&&!n.isRevealed&&(n.isRevealed=!0,this.emit("mine-revealed",{row:t,col:s}))}}stopTimer(){this.timerInterval&&(clearInterval(this.timerInterval),this.timerInterval=null)}startTimer(){this.timerInterval||(this.timerInterval=setInterval(()=>{this.gameState.elapsedTime++,this.gameState.elapsedTime>9999&&(this.gameState.elapsedTime=9999,this.stopTimer()),this.emit("timer-update",{elapsedTime:this.gameState.elapsedTime})},1e3))}newGame(e,t,s){this.timerInterval&&(clearInterval(this.timerInterval),this.timerInterval=null),this.board=new I(e,t,s),this.gameState={board:this.board.getBoard(),status:"playing",elapsedTime:0,minesRemaining:s,cellsRevealed:0,hasUsedUndo:!1},this.emit("new-game",{})}getState(){return{...this.gameState,board:this.board.getBoard()}}restoreState(e){this.gameState=JSON.parse(JSON.stringify(e)),this.board=new I(e.board.rows,e.board.cols,e.board.mines),this.board.board=JSON.parse(JSON.stringify(e.board)),this.emit("state-restored",{})}markUndoUsed(){this.gameState.hasUsedUndo=!0}on(e,t){this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t)}off(e,t){this.listeners.has(e)&&this.listeners.get(e).delete(t)}emit(e,t){if(this.listeners.has(e))for(const s of this.listeners.get(e))s(t)}destroy(){this.stopTimer(),this.listeners.clear()}}class O{constructor(e,t){h(this,"container");h(this,"gameEngine");h(this,"boardElement",null);h(this,"timerElement",null);h(this,"counterElement",null);h(this,"statusElement",null);h(this,"messageElement",null);h(this,"messageAlertElement",null);h(this,"probabilities",{});h(this,"learningModeEnabled",!1);h(this,"cellMap",new Map);this.container=e,this.gameEngine=t,this.cacheElements(),this.setupEventListeners()}cacheElements(){this.timerElement=document.getElementById("timer"),this.counterElement=document.getElementById("counter"),this.statusElement=document.getElementById("status"),this.messageElement=document.getElementById("message"),this.messageAlertElement=document.getElementById("message-alert")}setupEventListeners(){this.gameEngine.on("cell-revealed",e=>this.updateCell(e.row,e.col)),this.gameEngine.on("flag-toggled",e=>this.updateCell(e.row,e.col)),this.gameEngine.on("timer-update",e=>this.updateTimer(e.elapsedTime)),this.gameEngine.on("mine-revealed",e=>this.updateCell(e.row,e.col)),this.gameEngine.on("game-won",e=>this.onGameWon(e)),this.gameEngine.on("game-lost",()=>this.onGameLost()),this.gameEngine.on("new-game",()=>this.renderBoard()),this.gameEngine.on("state-restored",()=>this.renderBoard())}renderBoard(){const e=this.gameEngine.getState();e.board.minesGenerated||(this.probabilities={}),this.boardElement||(this.boardElement=document.createElement("div"),this.boardElement.id="game-board",this.boardElement.className="board",this.container.appendChild(this.boardElement),this.setupBoardInteractions()),this.boardElement.innerHTML="",this.boardElement.style.gridTemplateColumns=`repeat(${e.board.cols}, 1fr)`,this.cellMap.clear();const t=document.createDocumentFragment();for(let s=0;s<e.board.rows;s++)for(let n=0;n<e.board.cols;n++){const i=e.board.cells[s][n],a=this.createCellElement(i,s,n);this.cellMap.set(`${s},${n}`,a),t.appendChild(a)}this.boardElement.appendChild(t),this.updateInfo(e)}setupBoardInteractions(){if(!this.boardElement)return;const e=d=>d.target.closest(".cell"),t=d=>{const u=parseInt(d.dataset.row||"-1"),o=parseInt(d.dataset.col||"-1");return u>=0&&o>=0?{row:u,col:o}:null};let s=0,n=0,i=0,a=!1,r=!1,l=!1,c=null,E=!1,y=null;const C=400,S=300,v=15;this.boardElement.addEventListener("mousedown",d=>{if(e(d)&&this.gameEngine.getState().status==="playing"){const o=document.getElementById("status");o&&(o.textContent="ðŸ˜®")}}),this.boardElement.addEventListener("mouseup",()=>{const d=document.getElementById("status");if(d){const u=this.gameEngine.getState();d.textContent=u.status==="won"?"ðŸ˜Ž":u.status==="lost"?"ðŸ˜µ":"ðŸ˜Š"}}),this.boardElement.addEventListener("mouseleave",()=>{const d=document.getElementById("status");if(d){const u=this.gameEngine.getState();d.textContent=u.status==="won"?"ðŸ˜Ž":u.status==="lost"?"ðŸ˜µ":"ðŸ˜Š"}}),this.boardElement.addEventListener("click",d=>{if(r){d.preventDefault(),d.stopPropagation(),r=!1;return}const u=e(d);if(!u)return;const o=t(u);o&&this.gameEngine.getState().status==="playing"&&this.gameEngine.revealCell(o.row,o.col)}),this.boardElement.addEventListener("contextmenu",d=>{if(d.preventDefault(),r||l)return;const u=e(d);if(!u)return;const o=t(u);o&&this.gameEngine.getState().status==="playing"&&this.gameEngine.toggleFlag(o.row,o.col)}),this.boardElement.addEventListener("dblclick",d=>{d.preventDefault();const u=e(d);if(!u)return;const o=t(u);o&&this.gameEngine.getState().status==="playing"&&this.gameEngine.chord(o.row,o.col)}),this.boardElement.addEventListener("touchstart",d=>{const u=e(d);!u||this.gameEngine.getState().status!=="playing"||(l=!0,y=u,a=!1,E=!1,n=d.touches[0]?.clientX??0,i=d.touches[0]?.clientY??0,u.style.opacity="0.7",u.style.transform="scale(0.95)",c!==null&&(window.clearTimeout(c),c=null),c=window.setTimeout(()=>{if(!a&&!E&&y===u){E=!0,c=null,u.style.opacity="1",u.style.transform="";const o=t(u);o&&(this.gameEngine.toggleFlag(o.row,o.col),navigator.vibrate&&navigator.vibrate(50))}},C))},{passive:!0}),this.boardElement.addEventListener("touchmove",d=>{if(!y)return;const u=d.touches[0]?.clientX??0,o=d.touches[0]?.clientY??0,f=Math.abs(u-n),m=Math.abs(o-i);(f>v||m>v)&&(a=!0,y.style.opacity="1",y.style.transform="",c!==null&&(window.clearTimeout(c),c=null))},{passive:!0}),this.boardElement.addEventListener("touchend",d=>{if(l=!1,!y)return;const u=y;if(y=null,this.gameEngine.getState().status!=="playing")return;if(c!==null&&(window.clearTimeout(c),c=null),u.style.opacity="1",u.style.transform="",a){a=!1,E=!1;return}if(E){E=!1,d.preventDefault(),r=!0,window.setTimeout(()=>{r=!1},500);return}d.preventDefault(),r=!0,window.setTimeout(()=>{r=!1},500);const o=Date.now(),f=o-s;s=o;const m=t(u);m&&(f>0&&f<=S?(E=!0,this.gameEngine.chord(m.row,m.col)):(E=!0,this.gameEngine.revealCell(m.row,m.col)))},{passive:!1}),this.boardElement.addEventListener("touchcancel",()=>{l=!1,c!==null&&(window.clearTimeout(c),c=null),y&&(y.style.opacity="1",y.style.transform="",y=null),a=!1,r=!1,E=!1})}createCellElement(e,t,s){const n=document.createElement("div");return n.className="cell",n.id=`cell-${t}-${s}`,n.dataset.row=String(t),n.dataset.col=String(s),this.updateCellDisplay(n,e),n}updateCell(e,t){const s=this.gameEngine.getState(),n=s.board.cells[e][t],i=this.cellMap.get(`${e},${t}`);i&&n&&this.updateCellDisplay(i,n),s.status==="playing"&&this.updateCounter(s.minesRemaining)}updateCellDisplay(e,t){if(e.textContent="",e.className="cell",t.isRevealed)e.classList.add("revealed"),t.isMine?(e.textContent="ðŸ’£",e.classList.add("mine")):t.adjacentMines>0&&(e.textContent=String(t.adjacentMines),e.classList.add(`number-${t.adjacentMines}`));else if(e.classList.add("unrevealed"),t.isFlagged)e.textContent="ðŸš©",e.classList.add("flagged");else if(this.learningModeEnabled){const s=`${t.row},${t.col}`,n=this.probabilities[s];if(n!==void 0){const i=Math.round(n*100),a=document.createElement("span");a.className="probability",a.textContent=`${i}%`,n===0?a.classList.add("prob-safe"):n===1?a.classList.add("prob-mine"):n<.3?a.classList.add("prob-low"):n<.7?a.classList.add("prob-medium"):a.classList.add("prob-high"),e.appendChild(a)}}}updateTimer(e){if(this.timerElement){const t=Math.min(e,9999);this.timerElement.textContent=String(t).padStart(3,"0")}}updateCounter(e){if(this.counterElement){const t=Math.max(0,Math.min(e,999));this.counterElement.textContent=String(t).padStart(3,"0")}}updateInfo(e){this.updateTimer(e.elapsedTime),this.updateCounter(e.minesRemaining),this.updateStatus(e.status)}updateStatus(e){this.statusElement&&(e==="playing"?this.statusElement.textContent="ðŸ˜Š":e==="won"?this.statusElement.textContent="ðŸ˜Ž":e==="lost"&&(this.statusElement.textContent="ðŸ˜µ"))}onGameWon(e){this.updateStatus("won"),this.boardElement&&this.boardElement.classList.add("game-won"),this.messageElement&&(this.messageAlertElement&&(this.messageAlertElement.textContent=`You won! Time: ${e.time}s ${e.hasUsedUndo?"(with undo)":""}`),this.messageElement.style.color="green",this.messageElement.classList.add("has-alert"))}onGameLost(){this.updateStatus("lost"),this.boardElement&&this.boardElement.classList.add("game-lost"),this.messageElement&&(this.messageAlertElement&&(this.messageAlertElement.textContent="Game Over! You hit a mine."),this.messageElement.style.color="red",this.messageElement.classList.add("has-alert"))}clearMessage(){this.messageElement&&(this.messageAlertElement&&(this.messageAlertElement.textContent=""),this.messageElement.style.color="inherit",this.messageElement.classList.remove("has-alert")),this.boardElement&&this.boardElement.classList.remove("game-won","game-lost")}disableBoard(e=!0){this.boardElement&&(this.boardElement.style.pointerEvents=e?"none":"auto",this.boardElement.style.opacity=e?"0.5":"1")}updateProbabilities(e){if(this.probabilities=e,this.learningModeEnabled){const t=this.gameEngine.getState();for(let s=0;s<t.board.rows;s++)for(let n=0;n<t.board.cols;n++){const i=t.board.cells[s][n];!i.isRevealed&&!i.isFlagged&&this.updateCell(s,n)}}}setLearningMode(e,t){if(this.learningModeEnabled=e,e&&t)this.updateProbabilities(t);else if(!e){this.probabilities={};const s=this.gameEngine.getState();for(let n=0;n<s.board.rows;n++)for(let i=0;i<s.board.cols;i++){const a=s.board.cells[n][i];if(!a.isRevealed&&!a.isFlagged){const r=this.cellMap.get(`${n},${i}`);if(r){const l=r.querySelector(".probability");l&&r.removeChild(l)}}}}}destroy(){}}const G={easy:{rows:9,cols:9,mines:10},medium:{rows:16,cols:16,mines:40},custom:{rows:30,cols:16,mines:99}};function H(g){return G[g]||null}function T(){return Object.keys(G)}function F(g){return g.rows>=5&&g.rows<=50&&g.cols>=5&&g.cols<=50&&g.mines>0&&g.mines<g.rows*g.cols}const M={SETTINGS:"minesweeper_settings",HIGH_SCORES:"minesweeper_high_scores",CURRENT_GAME:"minesweeper_current_game"};class p{static loadSettings(){try{const e=localStorage.getItem(M.SETTINGS);if(e){const t=JSON.parse(e);return t.currentDifficulty==="hard"&&(t.currentDifficulty="custom"),t.customConfig||(t.customConfig=p.getDefaultSettings().customConfig),t}}catch(e){console.error("Error loading settings:",e)}return p.getDefaultSettings()}static saveSettings(e){try{localStorage.setItem(M.SETTINGS,JSON.stringify(e))}catch(t){console.error("Error saving settings:",t)}}static getDefaultSettings(){return{currentDifficulty:"easy",soundEnabled:!1,theme:"classic",customConfig:{rows:30,cols:16,mines:99},learningModeEnabled:!1}}static loadHighScores(){try{const e=localStorage.getItem(M.HIGH_SCORES);if(e)return JSON.parse(e).sort((s,n)=>s.time-n.time)}catch(e){console.error("Error loading high scores:",e)}return[]}static saveHighScore(e){try{const t=p.loadHighScores();t.push(e);const s=new Map;for(const i of t)s.has(i.difficulty)||s.set(i.difficulty,[]),s.get(i.difficulty).push(i);const n=[];for(const[i,a]of s)a.sort((r,l)=>r.time-l.time),n.push(...a.slice(0,10));localStorage.setItem(M.HIGH_SCORES,JSON.stringify(n))}catch(t){console.error("Error saving high score:",t)}}static getHighScoresForDifficulty(e){return p.loadHighScores().filter(s=>s.difficulty===e).slice(0,10)}static saveCurrentGame(e,t){try{const s={state:e,difficulty:t,timestamp:Date.now()};localStorage.setItem(M.CURRENT_GAME,JSON.stringify(s))}catch(s){console.error("Error saving current game:",s)}}static loadCurrentGame(){try{const e=localStorage.getItem(M.CURRENT_GAME);if(e){const t=JSON.parse(e);return t.difficulty==="hard"&&(t.difficulty="custom"),t}}catch(e){console.error("Error loading current game:",e)}return null}static clearCurrentGame(){try{localStorage.removeItem(M.CURRENT_GAME)}catch(e){console.error("Error clearing current game:",e)}}static isAvailable(){try{const e="__ls_test__";return localStorage.setItem(e,e),localStorage.removeItem(e),!0}catch{return!1}}}class A{static calculateProbabilities(e,t){const s=e.getBoard(),n={},i=new Set,a=[],r=new Set,l=new Set;for(let o=0;o<s.rows;o++)for(let f=0;f<s.cols;f++){const m=e.getCell(o,f);if(m&&(!m.isRevealed&&!m.isFlagged&&i.add(e.cellKey(o,f)),m.isRevealed&&m.adjacentMines>0)){const b=e.getNeighbors(o,f),B=b.filter(w=>!w.isRevealed&&!w.isFlagged),N=b.filter(w=>w.isFlagged),D=m.adjacentMines-N.length;B.length>0&&D>=0&&a.push({cells:B.map(w=>e.cellKey(w.row,w.col)),mines:D})}}let c=!0;for(;c;){c=!1;for(const o of a){let f=o.mines;const m=[];for(const b of o.cells)if(!r.has(b)){if(l.has(b)){f-=1;continue}m.push(b)}if(f=Math.max(0,f),o.cells=m,o.mines=f,m.length!==0){if(f===0)for(const b of m)r.has(b)||(r.add(b),c=!0);else if(f===m.length)for(const b of m)l.has(b)||(l.add(b),c=!0)}}}for(const o of r)n[o]=0;for(const o of l)n[o]=1;const E=new Set,y={},C={};for(const o of a){if(o.cells.length===0)continue;const f=o.mines/o.cells.length;for(const m of o.cells)r.has(m)||l.has(m)||(E.add(m),y[m]=(y[m]||0)+f,C[m]=(C[m]||0)+1)}for(const o of E)if(n[o]===void 0){const f=C[o]>0?y[o]/C[o]:0;n[o]=Math.max(0,Math.min(1,f))}const S=Math.max(0,t-l.size);let v=0;for(const o of E)v+=n[o]||0;const d=[];if(i.forEach(o=>{!E.has(o)&&n[o]===void 0&&d.push(o)}),d.length>0){const f=Math.max(0,S-v)/d.length;for(const m of d)n[m]=Math.max(0,Math.min(1,f))}const u=i.size>0?S/i.size:0;return i.forEach(o=>{n[o]===void 0&&(n[o]=Math.max(0,Math.min(1,u)))}),n}static getDefinitiveCells(e,t){const s=this.calculateProbabilities(e,t),n=[],i=[];for(const[a,r]of Object.entries(s)){const[l,c]=a.split(",").map(Number);r===0?n.push({row:l,col:c}):r===1&&i.push({row:l,col:c})}return{safe:n,mines:i}}}class ${constructor(e,t,s){h(this,"gameEngine");h(this,"renderer");h(this,"stateManager");h(this,"currentDifficulty","easy");h(this,"customConfig");h(this,"learningModeEnabled",!1);this.gameEngine=e,this.renderer=t,this.stateManager=s;const n=p.loadSettings();this.currentDifficulty=n.currentDifficulty,this.customConfig=n.customConfig||{rows:30,cols:16,mines:99},this.learningModeEnabled=n.learningModeEnabled||!1,this.setupControls(),this.setupGameEngineListeners()}setupControls(){const e=T();for(const l of e){const c=document.getElementById(`difficulty-${l}`);c&&c.addEventListener("click",()=>this.selectDifficulty(l))}const t=document.getElementById("status");t&&t.addEventListener("click",()=>this.newGame());const s=document.getElementById("undo-btn-header");s&&s.addEventListener("click",()=>this.undo());const n=document.getElementById("restart-btn");n&&n.addEventListener("click",()=>this.newGame());const i=document.getElementById("learning-mode-toggle");i&&(i.checked=this.learningModeEnabled,i.addEventListener("change",()=>{this.toggleLearningMode(i.checked)}));const a=document.getElementById("custom-cancel");a&&a.addEventListener("click",()=>this.closeCustomDialog());const r=document.getElementById("custom-start");r&&r.addEventListener("click",()=>this.applyCustomDialog()),this.updateDifficultyButtons(),this.updateCustomLabel()}setupGameEngineListeners(){this.gameEngine.on("cell-revealed",()=>{this.learningModeEnabled&&this.updateProbabilities()}),this.gameEngine.on("flag-toggled",()=>{this.learningModeEnabled&&this.updateProbabilities()}),this.gameEngine.on("new-game",()=>{this.learningModeEnabled&&this.updateProbabilities()}),this.gameEngine.on("state-restored",()=>{this.learningModeEnabled&&this.updateProbabilities()})}selectDifficulty(e){if(e==="custom"){this.openCustomDialog();return}this.currentDifficulty=e;const t=p.loadSettings();t.currentDifficulty=e,p.saveSettings(t),this.stateManager.clear(),this.newGame(),this.updateDifficultyButtons()}updateDifficultyButtons(){const e=T();for(const t of e){const s=document.getElementById(`difficulty-${t}`);s&&(t===this.currentDifficulty?s.classList.add("active"):s.classList.remove("active"))}}newGame(){let e=H(this.currentDifficulty);this.currentDifficulty==="custom"&&(e=this.customConfig),e&&(this.stateManager.clear(),this.renderer.clearMessage(),this.gameEngine.newGame(e.rows,e.cols,e.mines),this.renderer.renderBoard(),this.stateManager.saveState(this.gameEngine.getState()),this.updateUndoButton())}undo(){const e=this.stateManager.undo();e&&(this.gameEngine.getState().hasUsedUndo=!0,this.gameEngine.restoreState(e),this.renderer.clearMessage(),this.renderer.renderBoard(),this.updateUndoButton())}updateUndoButton(){const e=document.getElementById("undo-btn-header"),t=this.stateManager.canUndo();e&&(e.disabled=!t)}saveState(){const e=this.gameEngine.getState();this.stateManager.saveState(e),this.updateUndoButton()}getCurrentDifficulty(){return this.currentDifficulty}openCustomDialog(){const e=document.getElementById("custom-modal"),t=document.getElementById("custom-rows"),s=document.getElementById("custom-cols"),n=document.getElementById("custom-mines"),i=document.getElementById("custom-error");!e||!t||!s||!n||(t.value=String(this.customConfig.rows),s.value=String(this.customConfig.cols),n.value=String(this.customConfig.mines),i&&(i.textContent=""),e.classList.add("is-open"),e.setAttribute("aria-hidden","false"))}closeCustomDialog(){const e=document.getElementById("custom-modal");e&&(e.classList.remove("is-open"),e.setAttribute("aria-hidden","true"))}applyCustomDialog(){const e=document.getElementById("custom-rows"),t=document.getElementById("custom-cols"),s=document.getElementById("custom-mines"),n=document.getElementById("custom-error");if(!e||!t||!s)return;const i=Number(e.value),a=Number(t.value),r=Number(s.value),l={rows:i,cols:a,mines:r};if(!F(l)){n&&(i<5||i>50||a<5||a>50?n.textContent="Board size must be 5-50 for both rows and columns.":r<=0||r>=i*a?n.textContent=`Mines must be between 1 and ${i*a-1}.`:n.textContent="Invalid settings. Check sizes and mine count.");return}this.customConfig=l,this.currentDifficulty="custom";const c=p.loadSettings();c.currentDifficulty="custom",c.customConfig=l,p.saveSettings(c),this.closeCustomDialog(),this.newGame(),this.updateDifficultyButtons(),this.updateCustomLabel()}updateCustomLabel(){const e=document.getElementById("difficulty-custom");e&&(e.textContent=`Custom (${this.customConfig.rows}x${this.customConfig.cols})`)}resumeGame(){const e=p.loadCurrentGame();if(!e)return!1;const t=Date.now()-e.timestamp,s=24*60*60*1e3;if(t>s)return p.clearCurrentGame(),!1;if(this.currentDifficulty=e.difficulty,this.currentDifficulty==="custom"){const n=p.loadSettings();n.customConfig&&(this.customConfig=n.customConfig)}return this.gameEngine.restoreState(e.state),this.renderer.renderBoard(),this.stateManager.clear(),this.stateManager.saveState(e.state),this.updateUndoButton(),this.updateDifficultyButtons(),this.updateCustomLabel(),!0}toggleLearningMode(e){this.learningModeEnabled=e;const t=p.loadSettings();t.learningModeEnabled=e,p.saveSettings(t),e?this.updateProbabilities():this.renderer.setLearningMode(!1)}updateProbabilities(){if(!this.learningModeEnabled)return;const e=this.gameEngine.getState();if(e.status!=="playing"||!e.board.minesGenerated)return;const t=new I(e.board.rows,e.board.cols,e.board.mines);t.getBoard().cells=e.board.cells,t.getBoard().minesGenerated=e.board.minesGenerated;const s=A.calculateProbabilities(t,e.minesRemaining);this.renderer.setLearningMode(!0,s)}destroy(){}}class k{constructor(){h(this,"stateHistory",[]);h(this,"maxHistorySize",100)}saveState(e){const t=JSON.parse(JSON.stringify(e));this.stateHistory.push(t),this.stateHistory.length>this.maxHistorySize&&this.stateHistory.shift()}undo(){return this.stateHistory.length<2?null:(this.stateHistory.pop(),this.stateHistory[this.stateHistory.length-1])}canUndo(){return this.stateHistory.length>=2}getCurrentState(){return this.stateHistory.length===0?null:this.stateHistory[this.stateHistory.length-1]}clear(){this.stateHistory=[]}getHistorySize(){return this.stateHistory.length}setMaxHistorySize(e){for(this.maxHistorySize=Math.max(1,e);this.stateHistory.length>this.maxHistorySize;)this.stateHistory.shift()}}class P{constructor(){h(this,"gameEngine");h(this,"renderer");h(this,"controls");h(this,"stateManager");this.stateManager=new k;const e=p.loadSettings();let t=H(e.currentDifficulty);if(e.currentDifficulty==="custom"&&e.customConfig&&(t=e.customConfig),!t)throw new Error(`Invalid difficulty: ${e.currentDifficulty}`);this.gameEngine=new U(t.rows,t.cols,t.mines);const s=document.getElementById("board-container-inner");if(!s)throw new Error("Board container not found");this.renderer=new O(s,this.gameEngine),this.controls=new $(this.gameEngine,this.renderer,this.stateManager),this.setupStateManagement(),this.controls.resumeGame()||this.renderer.renderBoard(),this.displayHighScores()}setupStateManagement(){this.gameEngine.on("cell-revealed",()=>{this.controls.saveState();const e=this.gameEngine.getState();p.saveCurrentGame(e,this.controls.getCurrentDifficulty())}),this.gameEngine.on("flag-toggled",()=>{this.controls.saveState();const e=this.gameEngine.getState();p.saveCurrentGame(e,this.controls.getCurrentDifficulty())}),this.gameEngine.on("game-won",e=>{if(!e.hasUsedUndo){const t=this.controls.getCurrentDifficulty();p.saveHighScore({difficulty:t,time:e.time,timestamp:Date.now()}),this.displayHighScores()}p.clearCurrentGame()}),this.gameEngine.on("game-lost",()=>{p.clearCurrentGame()}),this.gameEngine.on("timer-update",e=>{if(e.elapsedTime%10===0){const t=this.gameEngine.getState();p.saveCurrentGame(t,this.controls.getCurrentDifficulty())}})}displayHighScores(){const e=["easy","medium","custom"];for(const t of e){const s=p.getHighScoresForDifficulty(t),n=document.getElementById(`${t}-scores`);if(n)if(n.innerHTML="",s.length===0){const i=document.createElement("li");i.textContent="No scores yet",n.appendChild(i)}else s.forEach(i=>{const a=document.createElement("li");a.textContent=`${i.time}s`,n.appendChild(a)})}}destroy(){this.gameEngine.destroy(),this.renderer.destroy(),this.controls.destroy()}}document.addEventListener("DOMContentLoaded",()=>{try{const g=new P;window.app=g,window.addEventListener("beforeunload",()=>{g.destroy()}),console.log("Minesweeper game initialized successfully")}catch(g){console.error("Failed to initialize game:",g);const e=document.getElementById("app");e&&(e.innerHTML=`<div style="color: red; padding: 20px;">
        Error initializing game: ${g instanceof Error?g.message:"Unknown error"}
      </div>`)}});
